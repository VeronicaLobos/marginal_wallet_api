<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Movement</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <div class="container d-flex flex-column align-items-center justify-content-center vh-100">
        <h1 class="mb-4">Add New Movement</h1>
        <div class="card p-4 shadow-sm" style="max-width: 500px; width: 100%;">
            <form id="add-movement-form">
                <div class="mb-3">
                    <label for="value" class="form-label">Value</label>
                    <input type="number" name="value" id="value" class="form-control" step="0.01" required>
                </div>
                <div class="mb-3">
                    <label for="currency" class="form-label">Currency</label>
                    <input type="text" name="currency" id="currency" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="movement_date" class="form-label">Date</label>
                    <input type="date" name="movement_date" id="movement_date" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="payment_method" class="form-label">Payment Method</label>
                    <input type="text" name="payment_method" id="payment_method" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="category_id" class="form-label">Category</label>
                    <select name="category_id" id="category_id" class="form-select" required>
                        <option value="">Select a category</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success w-100">Add Movement</button>
            </form>
            <div id="message" class="mt-3"></div>
        </div>
        <a href="/movements_page" class="btn btn-secondary mt-3">Back to Movements</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            // Fetch categories and populate dropdown
            const categorySelect = document.getElementById('category_id');
            const categoriesResponse = await fetch('/categories', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (categoriesResponse.ok) {
                const categories = await categoriesResponse.json();
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = `${category.category_type} - ${category.counterparty}`;
                    categorySelect.appendChild(option);
                });
            } else {
                // Handle error fetching categories
                console.error('Failed to fetch categories');
                // Optionally redirect or show error message
            }

            document.getElementById('add-movement-form').addEventListener('submit', async function(event) {
                event.preventDefault();

                const value = parseFloat(document.getElementById('value').value);
                const currency = document.getElementById('currency').value;
                const movement_date = document.getElementById('movement_date').value;
                const payment_method = document.getElementById('payment_method').value;
                const category_id = parseInt(document.getElementById('category_id').value);

                const messageDiv = document.getElementById('message');

                const response = await fetch(`/categories/${category_id}/movements`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        value: value,
                        currency: currency,
                        movement_date: movement_date,
                        payment_method: payment_method
                    })
                });

                if (response.ok) {
                    messageDiv.style.color = 'green';
                    messageDiv.textContent = 'Movement added successfully!';
                    // Optionally clear form fields
                    this.reset();
                } else {
                    const errorData = await response.json();
                    messageDiv.style.color = 'red';
                    messageDiv.textContent = errorData.detail || 'Failed to add movement';
                }
            });
        });
    </script>
</body>
</html>
